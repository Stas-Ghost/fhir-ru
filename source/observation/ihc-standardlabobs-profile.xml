<Profile xmlns="http://hl7.org/fhir" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://hl7.org/fhir ../../schema/profile.xsd">
  <!-- text will be generated by bild program -->
  
  <url value="http://ihc.org/fhir/Profile/StandardLabObs"/>
  <!-- stuff from metadata of CDL -->
  <version value="1.1"/>
  <name value="StandardLabObs"/>
  <publisher value="IHC"/>
  <description value="StandardLabObs is the base CDL Model for standard laboratory test results/observations such as hematology, chemistry, coagulation, serology and blood bank.  This model will not be used for microbiology, and anatomic pathology data"/>
  <status value="active"/>
  <experimental value="false"/>
  <date value="2011-10-03"/>

  <mapping>
    <!-- set up a formal mapping for the CDL Keys -->
    <identity value="cdl.key"/>
    <uri value="http://clinicalelement.com/cdl/key"/>
    <name value="CEM Key for the element"/>
  </mapping>
  
  <structure>
    <!-- this is a profile on Observation -->
    <type value="Observation"/>
    
    <!-- this is deried from observation directly -->
    <base value="http://hl7.org/fhir/Profile/Observation"/> 

    <!-- actually, this name is useless, but it's here right now as a publishing requirement (tooling limtiation to be addressed -->
    <name value="StandardLabObs"/>
    
    <!-- this is the constraint the profile expresses publically. other constraint statements below (if any) are in support of this, and are not used directly -->
    <publish value="true"/>
    
    <!-- The infrastructure will generate the snapshot for us
    <snapshot/>
    -->
    
    <differential>
    
<!-- 
 from the CDL - decisions about how to map 
 key domain(StandardLabObs_KEY_VALUESET_ECID);
  qualifier AccessionNumber accessionNumber card(0..1);              : in FHIR, in the Diagnostic Report  n/a
  qualifier FillerOrderNumber fillerOrderNumber card(0..1);          : in FHIR, in the Diagnostic Report  n/a
  qualifier PlacerOrderNumber placerOrderNumber card(0..1);          : in FHIR, in the Diagnostic Report  n/a
  qualifier ResultStatus resultStatus card(0..1);                    : Observation.status                 done
  qualifier ReportingPriority reportingPriority card(0..1);          : Extension on Observation 
  qualifier AbnormalInterpretation abnormalInterpretation card(0..1);: Observation.interpretation         done 
  qualifier OrdinalInterpretation ordinalInterpretation card(0..1);  : Observation.interpretation         done
  qualifier DeltaFlag deltaFlag card(0..1);                          : Extension on Observation (could be Observation.interpretation?)
  qualifier ResponsibleObserver responsibleObserver card(0-M);       : Observation.performer              done
  qualifier PerformingLaboratory performingLaboratory card(0..1);    : Observation.performer              done
  qualifier Comment comment card(0-M);                               : Observation.comments (collapse)    done
  modifier Subject subject card(0..1);                               : Observation.subject                done
  attribution SpecimenCollected specimenCollected card(0..1);        : Observation.specimen -(contained)-> Specimen.collection.collected
  attribution SpecimenReceivedByLab specimenReceivedByLab card(0..1);: Observation.specimen -(contained)-> Specimen.received
  attribution Resulted resulted card(0..1);                          : Observation.issued                 done
  attribution Verified verified card(0..1);                          : extension on Observation
  attribution Updated updated card(0..1);                            : complicated - extension? 
  constraint abnormalInterpretation.CD.code.domain (AbnormalInterpretation_VALUESET_ECID);
  constraint deltaFlag.CD.code.domain (DeltaFlag_VALUESET_ECID);
-->
    
      <element>
        <path value="Observation"/>
        <!-- nothing more to say about this. It simply exists for structural reasons -->        
      </element>

      <!-- see definitions of extensions below -->
      <element>
        <path value="Observation.extension"/>
        <name value="reportingPriority"/> <!-- need a name because we are slicing -->
        <definition>
          <type>
            <code value="Extension"/> <!-- redundant but required by profile definition -->
            <profile value="#reportingPriority"/>
          </type>
        </definition>
      </element>      
      <element>
        <path value="Observation.extension"/>
        <name value="deltaFlag"/> 
        <definition>
          <type>
            <code value="Extension"/> 
            <profile value="#deltaFlag"/>
          </type>
        </definition>
      </element>      
      <element>
        <path value="Observation.extension"/>
        <name value="verified"/> 
        <definition>
          <type>
            <code value="Extension"/> 
            <profile value="#verified"/>
          </type>
        </definition>
      </element>      
      <element>
        <path value="Observation.extension"/>
        <name value="updated"/> 
        <definition>
          <type>
            <code value="Extension"/> 
            <profile value="#updated"/>
          </type>
        </definition>
      </element>      
      
      
      <element>
        <path value="Observation.name"/>
        <!-- all we do here is make the key binding -->
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="StandardLabObs_KEY_VALUESET_ECID"/>
          </mapping>
        </definition>
      </element>
      
      <!-- nothing to say about the value in this profile
      <element>
        <path value="Observation.value[x]"/>
      </element>
      -->
      
      <element>
        <path value="Observation.interpretation"/>
        <!-- all we do here is narrow the binding of interpretation code -->
        <!-- There's a actually a problem here: CEM has 2 elements mapped here, AbnormalInterpretation and OrdinalInterpretation, 
          but there's only one interpretation code. But it doesn't seem rationale to use both kinds of codes at once, so we will go with this -->
        <definition>
          <binding>
            <name value="CEM_Ordinal_And_Abnormal"/>
            <isExtensible value="false"/> 
            <referenceResource>
              <reference value="ValueSet/Ordinal-Abnormal-Union"/> <!-- todo: make this, and do the code mappings -->
            </referenceResource>
          </binding>
          <mapping>
            <identity value="cdl.key"/>
            <map value="AbnormalInterpretation_KEY_ECID,OrdinalInterpretation_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      
      <element>
        <path value="Observation.comments"/>
        <definition>
          <comments value="In the CEM, there are multiple comments. Here, they are collapsed into a single string field. TODO: is that a problem?"/>
          <mapping>
            <identity value="cdl.key"/>
            <map value="Comment_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      
      <element>
        <path value="Observation.applies[x]"/>
        <!-- This isn't in the CEM - it will have to be derived from the specimen time. -->
        <definition>
          <max value="0"/> <!-- cannot be used here -->
        </definition>
      </element>
      
      <element>
        <path value="Observation.issued"/>
        <!-- 
           this a problem, this mapping. The CEM Attribution class carries many things that probably aren't going to be used. 
           We're going to assume that the start time / end time are the only thing that matters, and that they are equal,
           and simply map the whole thing to this element
        -->
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="Resulted_ECID"/>
          </mapping>
        </definition>
      </element>
     
      <element>
        <path value="Observation.status"/>
        <!--
          Mapping:
            No results available : registered
            Reported             : preliminary
            Not done             : cancelled
            Completed            : final?
            Final                : final
        -->
        <definition>
          <binding>
            <name value="ResultStatus_VALUESET_ECID"/>
            <isExtensible value="false"/> 
            <referenceResource>
              <reference value="ValueSet/ResultStatus_VALUESET_ECID"/> <!-- todo: check this, and do the code mappings -->
            </referenceResource>
          </binding>
          <mapping>
            <identity value="cdl.key"/>
            <map value="ResultStatus_KEY_ECID"/>
          </mapping>
        </definition>
      </element>

      <element>
        <path value="Observation.reliability"/>
        <definition>
          <valueCode value="ok"/> <!-- only reliable observations make it out of labs. TODO: what about ones with a nullFlavor? -->
        </definition>
      </element>
      
     <element>
        <path value="Observation.bodySite"/>
        <!-- This isn't in the CEM -->
        <definition>
          <max value="0"/> <!-- cannot be used here -->
        </definition>
      </element>
            
     <element>
        <path value="Observation.method"/>
        <!-- This isn't in the CEM -->
        <definition>
          <max value="0"/> <!-- cannot be used here -->
        </definition>
      </element>
            
     <element>
        <path value="Observation.identifier"/>
        <!-- This isn't in the CEM? -->
        <definition>
          <max value="0"/> <!-- cannot be used here -->
        </definition>
      </element>

      <element>
        <path value="Observation.subject"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="Subject_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
                        
      <element>
        <path value="Observation.specimen"/>
        <definition>
          <type>
            <code value="ResourceReference"/>
            <profile value="#Specimen"/>
            <aggregation value="contained"/> <!-- since all we have is 2 dates, this is contained -->
          </type>
        </definition>
      </element>

      <element>
        <path value="Observation.performer"/>
        <!-- there's 2 performers: the person, and the organization. we're going to have to slice this into 2 slices -->      
        <slicing>
          <discriminator value="performer.type"/> <!-- this is sliced by target resource type -->
          <ordered value="true"/> <!-- this is arbitrary, but we'll say it's true here -->
          <rules value="closed"/> <!-- we're not going to allow anything else here, just the 2 we define -->
        </slicing>
      </element>
      <!-- first slice: person -->
      <element>
        <path value="Observation.performer"/>
        <definition>
          <short value="the individual with the primary responsibility for the procedure or action being taken"/>
          <max value="*"/> <!-- strictly, this isn't something we needed to say, but a reader might overlook this -->
          <type>
            <code value="ResourceReference"/>
            <profile value="#ResponsibleObserver"/>
            <!-- <aggregation value="referenced"/>  we may or may not have an identifier for this, so we can't say whether it has to be contained or not -->
          </type>
          <mapping>
            <identity value="cdl.key"/>
            <map value="ResponsibleObserver_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      <!-- second slice: Performing lab -->
      <element>
        <path value="Observation.performer"/>
        <definition>
          <short value="documents the name and address of the laboratory that performs the test. This is a CLIA required item to be printed on the report, CLIA requires the name of the laboratory, city and state of the laboratory"/>
          <max value="1"/> <!-- only one of these -->
          <type>
            <code value="ResourceReference"/>
            <profile value="#PerformingLaboratory"/>
            <!-- <aggregation value="referenced"/>  we may or may not have an identifier for this, so we can't say whether it has to be contained or not -->
          </type>
          <mapping>
            <identity value="cdl.key"/>
            <map value="PerformingLaboratory_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      
      <!-- nothing to say about the value in this profile
      <element>
        <path value="Observation.referenceRange"/>
      </element>
      -->
            
     <element>
        <path value="Observation.related"/>
        <!-- This isn't in the CEM. TODO: this this a true statement for all derived profiles? -->
        <definition>
          <max value="0"/> <!-- cannot be used here -->
        </definition>
      </element>
                        
    </differential>
  </structure>

  <structure id="specimen">
    <type value="Specimen"/>
    <base value="http://hl7.org/fhir/Profile/Specimen"/>
    <name value="Specimen"/>
    <publish value="false"/> <!-- this is not published; it's only used in contained resources, so isn't available for external reference -->
    
    <!-- mainly this profile exists to make all the stuff on Specimen *go away* -->
    <differential>
      <element>
        <path value="Specimen"/>
      </element>
      <element>
        <path value="Specimen.identifier"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.type"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.source"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.subject"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.acessionIdentifier"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.receivedTime"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="SpecimenReceivedByLab_ECID"/>
          </mapping>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection"/>
      </element>
      <element>
        <path value="Specimen.collection.collector"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection.comment"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection.collected[x]"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="SpecimenCollected_ECID"/>
          </mapping>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection.quantity"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection.method"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.collection.sourceSite"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.treatment"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
      <element>
        <path value="Specimen.container"/>
        <definition>
          <max value="0"/>
        </definition>
      </element>
    </differential>
  </structure>

 <structure id="responsibleobserver">
    <type value="Practitioner"/>
    <base value="http://hl7.org/fhir/Profile/Practitioner"/>
    <name value="ResponsibleObserver"/>
    <publish value="true"/> <!-- this is published so it can referred to externally -->
    
    <!-- mainly this profile exists to map specific elements from Pracitioner to cdl.key. Don't close other things out -->
    <differential>
      <element>
        <path value="Practitioner"/>
      </element>
      <element>
        <path value="Practitioner.identifier"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="ProviderId_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      <element>
        <path value="Practitioner.name"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="ProviderName_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
    </differential>
  </structure>  
      
  <structure id="performinglaboratory">
    <type value="Organization"/>
    <base value="http://hl7.org/fhir/Profile/Organization"/>
    <name value="PerformingLaboratory"/>
    <publish value="true"/> <!-- this is published so it can referred to externally -->
    
    <!-- mainly this profile exists to map specific elements from Organization to cdl.key. Don't close other things out -->
    <differential>
      <element>
        <path value="Organization"/>
      </element>
      <element>
        <path value="Organization.identifier"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="LaboratoryId_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      <element>
        <path value="Organization.name"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="LaboratoryName_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
      <element>
        <path value="Organization.address"/>
        <definition>
          <mapping>
            <identity value="cdl.key"/>
            <map value="SimpleAddress_KEY_ECID"/>
          </mapping>
        </definition>
      </element>
    </differential>
  </structure>  
        
  <extensionDefn>
    <code value="reportingPriority"/>
    <!-- this extension is only used on the Observation Resource (todo: if that's not true, it would be better to define it in a different profile -->
    <contextType value="resource"/>
    <context value="Observation"/> 
    <element>
      <path value="reportingPriority"/>
      <definition>
        <short value="the urgency level for which results must be reported to a provider or responsible individual"/>
        <formal value="the urgency level for which results must be reported to a provider or responsible individual"/>
        <min value="0"/>
        <max value="1"/>
        <type>
          <code value="code"/>
        </type>
        <binding>
          <name value="ReportingPriority_VALUESET_ECID"/>
          <isExtensible value="false"/>
          <referenceResource>  
            <reference value="ValueSet/ReportingPriority_VALUESET_ECID"/>
          </referenceResource>
        </binding>
        <mapping>
          <identity value="cdl.key"/>
          <map value="ReportingPriority_KEY_ECID"/>
        </mapping>
      </definition>
    </element>
  </extensionDefn>
  
  <extensionDefn>
    <code value="deltaFlag"/>
    <contextType value="resource"/>
    <context value="Observation"/> 
    <element>
      <path value="deltaFlag"/>
      <definition>
        <short value="takes a value from the valueset listed in the model to indicate the data value in the containing model is a change from a previous instance of the same model"/>
        <formal value="takes a value from the valueset listed in the model to indicate the data value in the containing model is a change from a previous instance of the same model"/>
        <comments value="This model is intended to constrain values from OBX-8 in a lab result HL7 message. Because OBX-8 is overloaded to contain multiple types of data, we need a way to tell which kind of code is sent (abnormal flag, delta flag, or ordinal interpretation"/>
        <min value="0"/>
        <max value="1"/>
        <type>
          <code value="code"/>
        </type>
        <binding>
          <name value="DeltaFlag_VALUESET_ECID"/>
          <isExtensible value="false"/>
          <referenceResource>  
            <reference value="ValueSet/DeltaFlag_VALUESET_ECID"/>
          </referenceResource>
        </binding>
        <mapping>
          <identity value="cdl.key"/>
          <map value="DeltaFlag_KEY_ECID"/>
        </mapping>
      </definition>
    </element>
  </extensionDefn>

  <!-- see note on issued -->
  <extensionDefn>
    <code value="verified"/>
    <contextType value="resource"/>
    <context value="Observation"/> 
    <element>
      <path value="verified"/>
      <definition>
        <short value="Verified is the act of ensuring or double checking information for correctness"/>
        <formal value="Verified is the act of ensuring or double checking information for correctness"/>
        <min value="0"/>
        <max value="1"/>
        <type>
          <code value="dateTime"/>
        </type>
        <mapping>
          <identity value="cdl.key"/>
          <map value="Verified_ECID"/>
        </mapping>
      </definition>
    </element>
  </extensionDefn>

  <!-- see note on issued. Actually, this is a problem because issue is updated for an update. TODO: resolve this. -->
  <extensionDefn>
    <code value="updated"/>
    <contextType value="resource"/>
    <context value="Observation"/> 
    <element>
      <path value="updated"/>
      <definition>
        <short value="Updated captures the information attached to an update of an occurrence of data."/>
        <formal value="Updated captures the information attached to an update of an occurrence of data."/>
        <min value="0"/>
        <max value="1"/>
        <type>
          <code value="dateTime"/>
        </type>
        <mapping>
          <identity value="cdl.key"/>
          <map value="Verified_ECID"/>
        </mapping>
      </definition>
    </element>
  </extensionDefn>

</Profile>

